name: Build Rasterio Wheels

on:
  workflow_dispatch:
    inputs:
      rasterio_version:
        description: 'Rasterio version to build'
        required: true
        default: '1.3.9'
      python_version:
        description: 'Python version'
        required: true
        default: '3.12'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
      publish:
        description: 'Publish to GitHub Releases'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-wheel:
    name: Build rasterio ${{ inputs.rasterio_version }} for ARM64
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev python3-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '${{ inputs.python_version }}'

      - name: Build wheel
        run: |
          pip install --upgrade pip wheel auditwheel patchelf
          pip wheel rasterio==${{ inputs.rasterio_version }} --no-binary rasterio -w /tmp/wheels/

          # Repair wheel to get manylinux tag (2_39 matches Ubuntu 24.04's glibc)
          auditwheel repair /tmp/wheels/rasterio-*.whl -w dist/ --plat manylinux_2_39_aarch64
          ls -lh dist/

          # Save wheel filename for release notes
          echo "WHEEL_NAME=$(ls dist/)" >> $GITHUB_ENV

      - name: Test wheel
        run: |
          # rasterio 1.3.x requires numpy<2
          if [[ "${{ inputs.rasterio_version }}" == 1.3.* ]]; then
            pip install "numpy<2"
          fi
          pip install dist/rasterio-*.whl
          python -c "import rasterio; print(f'rasterio {rasterio.__version__}, GDAL {rasterio.__gdal_version__}')"

      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: rasterio-${{ inputs.rasterio_version }}-py${{ inputs.python_version }}-linux-aarch64
          path: dist/*.whl
          retention-days: 30

      - name: Create Release
        if: ${{ inputs.publish }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: rasterio-${{ inputs.rasterio_version }}-py${{ inputs.python_version }}-arm64
          name: Rasterio ${{ inputs.rasterio_version }} (Python ${{ inputs.python_version }}, ARM64 Linux)
          body: |
            ## Rasterio ${{ inputs.rasterio_version }} for ARM64 Linux

            **Python**: ${{ inputs.python_version }}
            **Architecture**: ARM64 (aarch64)

            ### Installation

            ```bash
            pip install https://github.com/${{ github.repository }}/releases/download/rasterio-${{ inputs.rasterio_version }}-py${{ inputs.python_version }}-arm64/${{ env.WHEEL_NAME }}
            ```

            **Requirements**:
            - System GDAL (`apt-get install libgdal-dev`)
            - `numpy<2` for rasterio 1.3.x

            **Compatibility**: glibc 2.39+ (Ubuntu 24.04+)
          files: dist/*.whl
          draft: false
          prerelease: false
